/**
 * Copyright (C) 2012 by Justin Windle
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */(function(e){var t=!1,n=document.createElement("div"),r=/^(Moz|(w|W)ebkit|O|ms)(?=[A-Z])/,i=function(){for(var e in n.style)if(r.test(e))return e.match(r)[0]}()||"",s=i+"Perspective"in n.style,o="-"+i.toLowerCase()+"-",u,a,f,l,c,h,p,d,v,m,g,y={toggle:function(){u=e(this),u.makisu(u.hasClass("open")?"close":"open")},open:function(t,n,r){u=e(this),a=u.find(".root"),l=u.find(".node").not(a),t=b.resolve(u,"speed",t),r=b.resolve(u,"easing",r),n=b.resolve(u,"overlap",n),l.each(function(i,s){m="unfold"+(i?"":"-first"),g=i===l.length-1,time=t*(1-n),v=i*time,h=e(s),p=h.find(".over"),h.css(b.prefix({transform:"rotateX(180deg)",animation:m+" "+t+"s "+r+" "+v+"s 1 normal forwards"})),g||(v=(i+1)*time),p.css(b.prefix({animation:"unfold-over "+t*.45+"s "+r+" "+v+"s 1 normal forwards"}))}),a.css(b.prefix({animation:"swing-out "+l.length*time*1.4+"s ease-in-out 0s 1 normal forwards"})),u.addClass("open")},close:function(t,n,r){u=e(this),a=u.find(".root"),l=u.find(".node").not(a),t=b.resolve(u,"speed",t)*.66,r=b.resolve(u,"easing",r),n=b.resolve(u,"overlap",n),l.each(function(i,s){m="fold"+(i?"":"-first"),g=i===0,time=t*(1-n),v=(l.length-i-1)*time,h=e(s),p=h.find(".over"),h.css(b.prefix({transform:"rotateX(0deg)",animation:m+" "+t+"s "+r+" "+v+"s 1 normal forwards"})),g||(v=(l.length-i-2)*time+t*.35),p.css(b.prefix({animation:"fold-over "+t*.45+"s "+r+" "+v+"s 1 normal forwards"}))}),a.css(b.prefix({animation:"swing-in "+l.length*time*1+"s ease-in-out 0s 1 normal forwards"})),u.removeClass("open")}},b={resolve:function(e,t,n){return typeof n=="undefined"?e.data(t):n},prefix:function(e){for(var t in e)e[o+t]=e[t];return e},inject:function(e){try{var t=document.createElement("style");t.innerHTML=e,document.getElementsByTagName("head")[0].appendChild(t)}catch(n){}}},w={node:'<span class="node"/>',back:'<span class="face back"/>',over:'<span class="face over"/>'};e.fn.makisu=function(n){if(!s){var r="Failed to detect CSS 3D support";console&&console.warn&&(console.warn(r),this.each(function(){e(this).trigger("error",r)}));return}t||(t=!0,b.inject("@"+o+"keyframes unfold        {"+"0%   {"+o+"transform: rotateX(180deg);  }"+"50%  {"+o+"transform: rotateX(-30deg);  }"+"100% {"+o+"transform: rotateX(0deg);    }"+"}"),b.inject("@"+o+"keyframes unfold-first  {"+"0%   {"+o+"transform: rotateX(-90deg);  }"+"50%  {"+o+"transform: rotateX(60deg);   }"+"100% {"+o+"transform: rotateX(0deg);    }"+"}"),b.inject("@"+o+"keyframes fold          {"+"0%   {"+o+"transform: rotateX(0deg);    }"+"100% {"+o+"transform: rotateX(180deg);  }"+"}"),b.inject("@"+o+"keyframes fold-first    {"+"0%   {"+o+"transform: rotateX(0deg);    }"+"100% {"+o+"transform: rotateX(-180deg); }"+"}"),b.inject("@"+o+"keyframes swing-out     {"+"0%   {"+o+"transform: rotateX(0deg);    }"+"30%  {"+o+"transform: rotateX(-30deg);  }"+"60%  {"+o+"transform: rotateX(15deg);   }"+"100% {"+o+"transform: rotateX(0deg);    }"+"}"),b.inject("@"+o+"keyframes swing-in      {"+"0%   {"+o+"transform: rotateX(0deg);    }"+"50%  {"+o+"transform: rotateX(-10deg);  }"+"90%  {"+o+"transform: rotateX(15deg);   }"+"100% {"+o+"transform: rotateX(0deg);    }"+"}"),b.inject("@"+o+"keyframes unfold-over   {"+"0%   { opacity: 1.0; }"+"100% { opacity: 0.0; }"+"}"),b.inject("@"+o+"keyframes fold-over     {"+"0%   { opacity: 0.0; }"+"100% { opacity: 1.0; }"+"}"),b.inject(".node {position: relative;display: block;}"),b.inject(".face {pointer-events: none;position: absolute;display: block;height: 100%;width: 100%;left: 0;top: 0;}"));var i=e.extend({},e.fn.makisu.defaults,n),v=Array.prototype.slice.call(arguments,1);return this.each(function(){if(y[n])return y[n].apply(this,v);u=e(this).data(i),u.data("initialized")||(u.data("initialized",!0),l=u.children(i.selector),a=e(w.node).addClass("root"),f=a,l.each(function(t,n){h=e(n),m="fold"+(t?"":"-first"),h.css("position","relative"),h.css(b.prefix({"transform-style":"preserve-3d",transform:"translateZ(-0.1px)"})),d=e(w.back),d.css("background",h.css("background")),d.css(b.prefix({transform:"translateZ(-0.1px)"})),p=e(w.over),p.css(b.prefix({transform:"translateZ(0.1px)"})),p.css({background:i.shading,opacity:0}),c=e(w.node).append(h),c.css(b.prefix({"transform-origin":"50% 0%","transform-style":"preserve-3d",animation:m+" 1ms linear 0s 1 normal forwards"})),h.append(p),h.append(d),f.append(c),f=c}),a.css(b.prefix({"transform-origin":"50% 0%","transform-style":"preserve-3d"})),u.css(b.prefix({transform:"perspective("+i.perspective+"px)"})),u.append(a))})},e.fn.makisu.defaults={perspective:1200,shading:"rgba(0,0,0,0.12)",selector:null,overlap:.6,speed:.8,easing:"ease-in-out"},e.fn.makisu.enabled=s})(jQuery);